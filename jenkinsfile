pipeline {
    agent any

    stages {
        stage("Install Dependencies") {
            agent {
                docker {
                    image 'node:18-alpine'
                    reuseNode true
                }
            }
            steps {
                sh '''
                    npm install
                    npm install --save-dev mocha
                '''
            }
        }

        stage("Build Docker Image") {
            steps {
                sh "docker build -t node_web_app ."
            }
        }

        stage("Run Tests") {
            agent {
                docker {
                    image 'node:18-alpine'
                    reuseNode true
                }
            }
            steps {
                sh 'npm test'
            }
        }

        stage('Deploy Container') {
            steps {
                sh '''
                    docker rm -f node_web_container || true
                    docker run -d \
                    --name node_web_container \
                    --network jenkins_net \
                    -p 3000:3000 \
                    node_web_app
                '''
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed'
        }
    }
}
